# Forum Application

A Spring Boot-based forum application that provides REST API endpoints for managing threads, subthreads, messages, and user interactions with model-specific access control.

## ðŸ› ï¸ Technologies & Dependencies

### Core Framework
- **Spring Boot 3.1.5** - Main application framework
- **Java 21** - Programming language
- **Maven** - Dependency management and build tool

### Database & Persistence
- **Spring Data JPA** - Data access layer
- **PostgreSQL** - Primary database
- **Hibernate** - ORM implementation

### Security & Validation
- **Spring Security** - Authentication and authorization
- **Spring Boot Validation** - Input validation

### Documentation & Development
- **SpringDoc OpenAPI 3** (v2.1.0) - API documentation and Swagger UI
- **Spring Boot DevTools** - Development utilities
- **Lombok** - Code generation (getters, setters, constructors)

### Additional Features
- **Spring Boot Actuator** - Application monitoring
- **Spring Boot Docker Compose** - Container integration

## ðŸš€ Getting Started

### Prerequisites
- Java 21
- PostgreSQL database
- Maven (or use VS Code with Java Extension Pack)

### Database Setup
1. Create a PostgreSQL database named `forum`
2. Update database credentials in `src/main/resources/application.yml`
3. The application will automatically create tables and insert dummy data on startup

### Running the Application
1. Clone the repository
2. Open in VS Code or your preferred IDE
3. Run the `ForumApplication.java` main class
4. Application will start on `http://localhost:8080`

## ðŸ“š API Documentation (Swagger UI)

### Accessing Swagger UI
Once the application is running, access the interactive API documentation at:
**ðŸ”— [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)**

### ðŸ“‹ Available API Endpoints

#### ðŸ§µ Thread Management
- **GET** `/threads/getAllThreads` - Retrieve all threads
- **POST** `/threads/createThread` - Create a new thread
- **GET** `/threads/{id}` - Get thread by ID
- **DELETE** `/threads/deleteThread/{id}` - Delete a thread

#### ðŸŒ¿ SubThread Management  
- **GET** `/subThreads/allSubThreadsByThreadId/{threadId}` - Get all subthreads for a specific thread
- **POST** `/subThreads/createSubThread` - Create a new subthread
- **GET** `/subThreads/{id}` - Get subthread by ID
- **DELETE** `/subThreads/deleteSubThread/{id}` - Delete a subthread

#### ðŸ’¬ Message Management
- **GET** `/messages/allMessagesBySubThreadId/{id}` - Get all messages for a specific subthread
- **POST** `/messages/createMessage` - Create a new message
- **GET** `/messages/{id}` - Get message by ID
- **DELETE** `/messages/deleteMessage/{id}` - Delete a message

#### ðŸ‘ Message Voting
- **POST** `/messageVotes/createMessageVote` - Vote on a message
- **DELETE** `/messageVotes/deleteMessageVote/{id}` - Remove a vote

## ðŸŽ¯ How to Use Swagger UI for Testing

### âš ï¸ Important Note About Input Fields
When using Swagger UI to test endpoints, you'll see JSON input examples that include fields like `id`, `createdAt`, `updatedAt`, etc. **These fields should be DELETED from your input** as they are auto-generated by the system.

### ðŸ“ Input Examples for Each Endpoint

#### Creating a Thread
**Endpoint:** `POST /threads/createThread`

**âŒ Default Swagger Input (Don't use this):**
```json
{
  "id": 0,
  "username": "string",
  "role": 0,
  "modelId": "string",
  "title": "string",
  "createdAt": "2025-09-08T18:48:24.337Z"
}
```

**âœ… Correct Input (Use this):**
```json
{
  "username": "alice_johnson",
  "role": 0,
  "modelId": "BMW",
  "title": "Best BMW maintenance tips"
}
```

#### Creating a SubThread
**Endpoint:** `POST /subThreads/createSubThread`

**âœ… Correct Input:**
```json
{
  "username": "bob_smith",
  "title": "Engine maintenance discussion",
  "threadId": 1
}
```

#### Creating a Message
**Endpoint:** `POST /messages/createMessage`

**âœ… Correct Input:**
```json
{
  "username": "charlie_brown",
  "body": "This is my message content about car maintenance.",
  "subthreadId": 1
}
```

#### Creating a Message Vote
**Endpoint:** `POST /messageVotes/createMessageVote`

**âœ… Correct Input:**
```json
{
  "username": "diana_wilson",
  "messageId": 1
}
```

## ðŸ‘¥ Available Test Users

The application comes with pre-populated test users you can use:

| Username | Model ID | Role | Message/Description |
|----------|----------|------|---------------------|
| alice_johnson | BMW | 0 (Admin) | Hi, I'm Alice and I love cars! |
| bob_smith | Mercedes | 1 (User) | Greetings from Bob, car enthusiast. |
| charlie_brown | Audi | 1 (User) | Charlie here, always ready to help! |
| diana_wilson | Tesla | 1 (User) | Diana's passion for electric vehicles. |
| eve_davis | BMW | 1 (User) | Eve enjoys weekend car meets. |
| frank_miller | Mercedes | 0 (Admin) | Frank has years of automotive experience. |
| grace_lee | Audi | 1 (User) | Grace appreciates German engineering. |
| henry_taylor | Tesla | 1 (User) | Henry is an advocate for sustainable transport. |

### Using Test Users
When making API calls, use the **username** field with one of the usernames above (e.g., `"username": "alice_johnson"`).

## ðŸ”’ Access Control Rules

### Model-Based Restrictions
- Users can only create **threads** for their assigned `model_id`
- Users can only create **subthreads** in threads that match their `model_id`
- **Cross-model posting is blocked** - BMW users cannot post in Mercedes threads

### Validation Flow
1. **Thread Creation:** User's `model_id` must match thread's `model_id`
2. **SubThread Creation:** User's `model_id` must match parent thread's `model_id`
3. **Message Creation:** User must exist and have valid access to the subthread

## ðŸ›¡ï¸ Error Handling

The application uses a global exception handler that returns clean JSON error responses:

### Example Error Response
```json
{
  "status": false,
  "message": "[UserNotFoundException] User 'alice_johnson' does not have a model_id assigned. Cannot perform operation.",
  "data": null
}
```

### Common Error Types
- **UserNotFoundException** (404) - User doesn't exist or has no model_id
- **IdMismatchException** (400) - User's model_id doesn't match required model_id
- **MissingRelationException** (400) - Required parent entity not found

## ðŸ—„ï¸ Database Schema

### Tables
- **users** - User accounts with model assignments and personal messages
- **threads** - Main discussion topics  
- **subthreads** - Sub-discussions within threads
- **messages** - Individual posts within subthreads
- **message_vote** - Upvoting system for messages

### Key Relationships
- Thread â†’ SubThread (one-to-many)
- SubThread â†’ Message (one-to-many)  
- User â†’ Message Vote (many-to-many through message_vote table)

## ðŸ§ª Testing Workflow

1. **Start with Threads:** Create a thread using one of the test usernames (e.g., `"username": "alice_johnson"`)
2. **Add SubThreads:** Create subthreads within your thread using the same username
3. **Post Messages:** Add messages to subthreads
4. **Vote on Messages:** Use the voting system to upvote messages
5. **Test Restrictions:** Try cross-model posting (e.g., BMW user posting in Mercedes thread) to see access control in action

### Example Cross-Model Testing
- Try `alice_johnson` (BMW) creating a thread with `"modelId": "Mercedes"` â†’ Should fail
- Try `bob_smith` (Mercedes) creating a subthread in a BMW thread â†’ Should fail

## ðŸ“Š Response Format

All API responses follow this consistent format:

```json
{
  "status": boolean,
  "message": "string",
  "data": object | null
}
```

- **status**: `true` for success, `false` for errors
- **message**: Descriptive message about the operation
- **data**: The actual response data or `null` for errors

---

# Forum API (Threads / SubThreads / Messages / Votes)

## Base
All responses use:
{
  "success": true|false,
  "message": "info",
  "data": ...
}

Authentication: current user resolved from security context (JWT/session) OR explicitly via `username` field/query parameter where shown.

---

## Threads (if implemented similarly)
(Only include if you have these; otherwise skip.)
POST /threads/createThread  
POST /threads/updateThread/{id}  
DELETE /threads/deleteThread/{id}  
GET /threads/viewThread/{id}  
GET /threads/viewThreadsByModel/{modelId}

Body (create/update):
{
  "title": "Engine discussion",
  "vehicleType": "CAR",
  "modelId": "model123",
  "username": "john_doe"        // optional (admin can act as others)
}

---

## SubThreads
POST /subThreads/createSubThread  
POST /subThreads/updateSubThread/{id}  
DELETE /subThreads/deleteSubThread/{id}  
GET /subThreads/{id}  
GET /subThreads/allSubThreadsByThreadId/{threadId}

Create body:
{
  "threadId": 5,
  "title": "Cylinder head details",
  "username": "john_doe"
}

Update body (only mutable fields):
{
  "title": "Updated title",
  "username": "john_doe"
}

Sample success:
{
  "success": true,
  "message": "SubThread created successfully",
  "data": {
    "id": 12,
    "threadId": 5,
    "title": "Cylinder head details",
    "username": "john_doe",
    "createdAt": "2025-09-11T10:22:15Z"
  }
}

---

## Messages
GET /messages/viewMessage/{id}?includeVoters=false  
GET /messages/viewMessagesBySubThread/{subThreadId}?includeVoters=true  
POST /messages/createMessage  
PATCH /messages/updateMessage/{id}  
DELETE /messages/deleteMessage/{id}?username=john_doe (optional if context auth)

Create body:
{
  "subThreadId": 12,
  "body": "Check torque specs.",
  "username": "john_doe"
}

Update body:
{
  "body": "Updated content",
  "username": "john_doe"
}

Single view (includeVoters=true):
{
  "success": true,
  "message": "Message fetched",
  "data": {
    "id": 33,
    "subThreadId": 12,
    "userId": 2,
    "username": "john_doe",
    "body": "Check torque specs.",
    "createdAt": "...",
    "updatedAt": null,
    "upvoteCount": 4,
    "voters": ["alice","bob","charlie","dave"]
  }
}

---

## Message Votes
POST /messageVotes/createMessageVote  
POST /messageVotes/updateMessageVote (toggle / change)  
DELETE /messageVotes/deleteMessageVote?messageId=33&username=john_doe  
GET /messageVotes/viewMessageVotes/{messageId}

Create / toggle body:
{
  "messageId": 33,
  "upvoted": true,
  "username": "john_doe"
}

Vote list:
{
  "success": true,
  "message": "Votes fetched",
  "data": [
    { "messageId": 33, "userId": 2, "username": "john_doe", "upvoted": true, "createdAt": "...", "updatedAt": null }
  ]
}

Rules:
- Non-admin: user.modelId must match parent thread.modelId.
- Admin bypasses modelId restrictions.
- One vote per (user,message). Same vote twice removes it (toggle logic).
- Upvote count maintained on Message.

---

## Error Examples
401:
{
  "success": false,
  "message": "No user context",
  "data": null
}

400 (model mismatch):
{
  "success": false,
  "message": "Model mismatch: user cannot post to this thread",
  "data": null
}

---

## cURL Examples

Create message:
curl -X POST http://localhost:8080/messages/createMessage ^
  -H "Content-Type: application/json" ^
  -d "{\"subThreadId\":12,\"body\":\"Check torque specs.\",\"username\":\"john_doe\"}"

View messages (desc by upvotes):
curl http://localhost:8080/messages/viewMessagesBySubThread/12

Vote:
curl -X POST http://localhost:8080/messageVotes/createMessageVote ^
  -H "Content-Type: application/json" ^
  -d "{\"messageId\":33,\"upvoted\":true,\"username\":\"john_doe\"}"

Toggle (remove same upvote):
curl -X POST http://localhost:8080/messageVotes/updateMessageVote ^
  -H "Content-Type: application/json" ^
  -d "{\"messageId\":33,\"upvoted\":true,\"username\":\"john_doe\"}"

---

## Persistence / Schema Notes
- Avoid schema reset: remove DROP statements or set spring.sql.init.mode=never.
- Use BIGINT for user_id consistently (users.id FK).
- Fetch joins used to prevent LazyInitializationException on message -> subThread -> thread chain.

---

## Minimal Required Fields Summary
Thread: title, vehicleType, modelId  
SubThread: threadId, title  
Message: subThreadId, body  
Vote: messageId, upvoted (true/false)  

Username optional if auth context supplies principal; required otherwise.

---

## Admin Behavior
- Admin can act across modelId boundaries.
- Admin can